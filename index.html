<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>N-Dimensional Vector Field Flow</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* Light theme */
        body.light-theme {
            background: #f5f5f5;
            color: #212121;
        }

        body.light-theme #canvas {
            filter: invert(1);
        }

        body.light-theme #grid-canvas {
            filter: invert(1);
        }

        body.light-theme #controls {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ccc;
            color: #212121;
        }

        body.light-theme #controls h1 {
            color: #2E7D32;
        }

        body.light-theme #controls h2 {
            color: #1976D2;
            border-color: #ddd;
        }

        body.light-theme #controls h2:hover {
            background: rgba(25, 118, 210, 0.1);
        }

        body.light-theme label {
            color: #555;
        }

        body.light-theme input[type="text"],
        body.light-theme input[type="number"],
        body.light-theme textarea,
        body.light-theme select {
            background: #fff;
            border-color: #ccc;
            color: #212121;
        }

        body.light-theme .slider-btn {
            background: #e0e0e0;
            color: #333;
            border-color: #bbb;
        }

        body.light-theme .slider-btn:hover {
            background: #d0d0d0;
            border-color: #999;
        }

        body.light-theme .info {
            color: #666;
        }

        body.light-theme #cursor-position {
            background: rgba(255, 255, 255, 0.9);
            border-color: #ccc;
            color: #2E7D32;
        }

        body.light-theme #step-time-counter {
            background: rgba(255, 255, 255, 0.9);
            border-color: #ccc;
            color: #F57C00;
        }

        body.light-theme #fps-counter {
            background: rgba(255, 255, 255, 0.9);
            border-color: #ccc;
            color: #2E7D32;
        }

        body.light-theme #debug-console {
            background: rgba(250, 250, 250, 0.95);
            border-color: #ccc;
        }

        body.light-theme #debug-header {
            border-color: #ddd;
        }

        body.light-theme #debug-header h3 {
            color: #2E7D32;
        }

        body.light-theme #debug-output {
            background: #fff;
            border-color: #ddd;
            color: #212121;
        }

        body.light-theme .debug-log.info { color: #1976D2; }
        body.light-theme .debug-log.debug { color: #546E7A; }
        body.light-theme .debug-log.warn { color: #F57C00; }
        body.light-theme .debug-log.error { color: #C62828; }
        body.light-theme .debug-log.verbose { color: #666; }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: move;
        }

        #grid-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        #cursor-position {
            position: absolute;
            bottom: 220px;
            left: 10px;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #4CAF50;
            z-index: 100;
            transition: left 0.3s ease-in-out;
        }

        #cursor-position.shifted {
            right: 390px;
            left: auto;
        }

        #histogram-panel {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 300px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 4px;
            z-index: 100;
            transition: left 0.3s ease-in-out, right 0.3s ease-in-out;
        }

        #histogram-panel.shifted {
            right: 390px;
            left: auto;
        }

        #histogram-panel.collapsed #histogram-body {
            display: none;
        }

        #histogram-header {
            padding: 8px 12px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #histogram-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        #histogram-header h4 {
            margin: 0;
            font-size: 12px;
            color: #4CAF50;
            flex: 1;
        }

        #histogram-expand {
            font-size: 10px;
            color: #888;
        }

        #histogram-body {
            padding: 8px 12px;
            border-top: 1px solid #444;
        }

        #histogram-canvas {
            width: 100%;
            height: 120px;
            display: block;
        }

        #histogram-info {
            margin-top: 8px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #888;
        }

        #step-time-counter {
            position: absolute;
            bottom: 48px;
            right: 10px;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #FFA726;
            z-index: 10;
        }

        #fps-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(30, 30, 30, 0.9);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 8px 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            font-weight: bold;
            color: #4CAF50;
            z-index: 10;
        }

        #controls {
            position: absolute;
            top: 50px;
            right: 20px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            width: 340px;
            max-height: calc(90vh - 60px);
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 200;
        }

        #controls h1 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        #zoom-pan-controls {
            position: absolute;
            top: 50px;
            right: 380px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 8px;
            width: 130px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 150;
        }

        #zoom-pan-controls h1 {
            font-size: 12px;
            margin-bottom: 6px;
            color: #4CAF50;
            text-align: center;
        }

        body.light-theme #zoom-pan-controls {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ccc;
            color: #212121;
        }

        body.light-theme #zoom-pan-controls h1 {
            color: #2E7D32;
        }

        .zoom-pan-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 3px;
            margin-bottom: 6px;
        }

        .zoom-pan-btn {
            background: #333;
            color: #ccc;
            border: 1px solid #555;
            padding: 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            user-select: none;
            transition: background 0.2s, border-color 0.2s;
        }

        .zoom-pan-btn:hover {
            background: #444;
            border-color: #666;
        }

        .zoom-pan-btn:active {
            background: #222;
        }

        body.light-theme .zoom-pan-btn {
            background: #e0e0e0;
            color: #333;
            border-color: #bbb;
        }

        body.light-theme .zoom-pan-btn:hover {
            background: #d0d0d0;
            border-color: #999;
        }

        body.light-theme .zoom-pan-btn:active {
            background: #c0c0c0;
        }

        .zoom-btn-group {
            display: flex;
            gap: 4px;
        }

        .zoom-btn {
            flex: 1;
        }

        #display-options {
            position: absolute;
            top: 50px;
            left: 20px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 12px;
            width: 240px;
            max-height: calc(90vh - 60px);
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }

        #display-options h1 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        body.light-theme #display-options {
            background: rgba(255, 255, 255, 0.95);
            border-color: #ccc;
            color: #212121;
        }

        body.light-theme #display-options h1 {
            color: #2E7D32;
        }

        #animation-section-content {
            max-height: calc(70vh - 200px);
            overflow-y: auto;
            padding-right: 4px;
        }

        /* Scrollbar styling for animation sections */
        #animation-section-content::-webkit-scrollbar,
        #display-options::-webkit-scrollbar {
            width: 8px;
        }

        #animation-section-content::-webkit-scrollbar-track,
        #display-options::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        #animation-section-content::-webkit-scrollbar-thumb,
        #display-options::-webkit-scrollbar-thumb {
            background: rgba(76, 175, 80, 0.5);
            border-radius: 4px;
        }

        #animation-section-content::-webkit-scrollbar-thumb:hover,
        #display-options::-webkit-scrollbar-thumb:hover {
            background: rgba(76, 175, 80, 0.7);
        }

        #controls h2 {
            font-size: 13px;
            margin: 10px 0 6px 0;
            color: #64B5F6;
            border-bottom: 1px solid #333;
            padding: 6px 8px 6px 0;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
        }

        #controls h2:hover {
            background: rgba(100, 181, 246, 0.1);
        }

        #controls h2::after {
            content: 'â–¼';
            font-size: 10px;
            transition: transform 0.2s;
        }

        #controls h2.collapsed::after {
            transform: rotate(-90deg);
        }

        .accordion-section {
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        }

        .accordion-section.collapsed {
            max-height: 0 !important;
            opacity: 0;
        }

        .control-group {
            margin-bottom: 10px;
        }

        .control-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .control-row .control-group {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 11px;
            margin-bottom: 3px;
            color: #aaa;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 6px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        textarea {
            resize: vertical;
            min-height: 32px;
        }

        input[type="range"] {
            width: 100%;
            margin: 3px 0;
            flex: 1;
        }

        .range-value {
            display: inline-block;
            float: right;
            font-size: 10px;
            color: #888;
        }

        .slider-control {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .slider-btn {
            background: #333;
            color: #ccc;
            border: 1px solid #555;
            padding: 1px 5px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            min-width: 24px;
            text-align: center;
            user-select: none;
            flex-shrink: 0;
        }

        .slider-btn:hover {
            background: #444;
            border-color: #666;
        }

        .slider-btn:active {
            background: #222;
        }

        .slider-btn.anim-btn.active {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* Animation bounds slider */
        .animation-bounds-slider {
            margin: 8px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            border: 1px solid #444;
        }

        .bounds-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .bounds-labels span {
            font-weight: bold;
        }

        /* Multi-thumb slider */
        .multi-thumb-slider {
            position: relative;
            height: 32px;
            margin: 4px 0;
        }

        .slider-track {
            position: absolute;
            top: 14px;
            left: 0;
            right: 0;
            height: 4px;
            background: #333;
            border-radius: 2px;
        }

        .slider-range {
            position: absolute;
            top: 14px;
            height: 4px;
            background: #4CAF50;
            border-radius: 2px;
            pointer-events: none;
        }

        .slider-current-indicator {
            position: absolute;
            top: 12px;
            width: 2px;
            height: 8px;
            background: #FFA726;
            pointer-events: none;
            z-index: 5;
            transform: translateX(-1px);
        }

        .slider-thumb {
            position: absolute;
            top: 0;
            width: 16px;
            height: 32px;
            background: #555;
            border: 2px solid #888;
            border-radius: 4px;
            cursor: grab;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: background 0.2s, border-color 0.2s;
        }

        .slider-thumb:hover {
            background: #666;
            border-color: #aaa;
        }

        .slider-thumb.dragging {
            cursor: grabbing;
            background: #777;
            border-color: #ccc;
            z-index: 11;
        }

        .slider-thumb.min-thumb {
            border-color: #2196F3;
        }

        .slider-thumb.max-thumb {
            border-color: #F44336;
        }

        .slider-thumb.min-thumb:hover {
            border-color: #42A5F5;
        }

        .slider-thumb.max-thumb:hover {
            border-color: #EF5350;
        }

        .thumb-label {
            font-size: 7px;
            font-weight: bold;
            color: #ccc;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin: 3px 3px 3px 0;
        }

        button:hover {
            background: #45a049;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        .dimension-inputs {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dimension-input {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dimension-input label {
            min-width: 22px;
            margin: 0;
        }

        .dimension-input input {
            flex: 1;
        }

        .info {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
            font-style: italic;
        }

        .floating-panel {
            position: fixed;
            right: 330px;
            top: 50px;
            width: 320px;
            max-height: calc(90vh - 60px);
            background: rgba(30, 30, 30, 0.98);
            border: 1px solid #444;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            z-index: 900;
            animation: slideInFromLeft 0.2s ease-out;
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        body.light-theme .floating-panel {
            background: rgba(255, 255, 255, 0.98);
            border-color: #ccc;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .floating-panel-header {
            padding: 12px;
            background: #252525;
            border-bottom: 1px solid #444;
        }

        body.light-theme .floating-panel-header {
            background: #f5f5f5;
            border-bottom-color: #ddd;
        }

        .floating-panel-header h3 {
            margin: 0;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
        }

        body.light-theme .floating-panel-header h3 {
            color: #212121;
        }

        .floating-panel-content {
            padding: 12px;
            max-height: calc(90vh - 110px);
            overflow-y: auto;
        }

        #gradient-preset-toggle {
            border-bottom-color: #444 !important;
        }

        body.light-theme #gradient-preset-toggle {
            border-bottom-color: #ddd !important;
        }

        #error-message {
            background: #d32f2f;
            color: white;
            padding: 6px;
            border-radius: 4px;
            margin-top: 6px;
            display: none;
            font-size: 10px;
        }

        #debug-console {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(20, 20, 20, 0.95);
            border-bottom: 1px solid #444;
            width: 100%;
            max-height: 350px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #debug-console.collapsed {
            max-height: 36px;
        }

        #debug-header {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            user-select: none;
        }

        #debug-console.collapsed #debug-header {
            border-bottom: none;
        }

        #debug-header h3 {
            flex: 1;
            margin: 0;
            font-size: 14px;
            color: #4CAF50;
        }

        #debug-toggle {
            margin: 0 10px 0 0;
        }

        #debug-expand {
            font-size: 12px;
            color: #888;
        }

        #debug-body {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        #debug-console.collapsed #debug-body {
            display: none;
        }

        #debug-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        #debug-verbosity {
            flex: 1;
        }

        #debug-output {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 8px;
            height: 240px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            color: #e0e0e0;
            line-height: 1.4;
        }

        .debug-log {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #282828;
        }

        .debug-log.info { color: #64B5F6; }
        .debug-log.debug { color: #90A4AE; }
        .debug-log.warn { color: #FFB74D; }
        .debug-log.error { color: #E57373; }
        .debug-log.verbose { color: #888; }

        .debug-timestamp {
            color: #666;
            margin-right: 8px;
        }

        /* Gradient editor styles */
        .gradient-stops {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 8px;
        }

        .gradient-stop {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .gradient-stop .color-picker {
            width: 40px;
            height: 25px;
            padding: 0;
            border: 1px solid #444;
            cursor: pointer;
        }

        .gradient-stop .stop-position {
            width: 60px;
            padding: 4px;
        }

        .gradient-stop .remove-stop {
            background: #d32f2f;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .gradient-stop .remove-stop:hover {
            background: #b71c1c;
        }

        .gradient-preview {
            width: 100%;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #444;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div id="controls">
        <h1>N-Dimensional Vector Field</h1>

        <div class="control-row">
            <div class="control-group" style="flex: 1;">
                <label>Theme:</label>
                <select id="theme-selector">
                    <option value="dark" selected>Dark Mode</option>
                    <option value="light">Light Mode</option>
                </select>
            </div>

            <div class="control-group" style="flex: 1;">
                <label>Preset Examples:</label>
                <select id="preset-selector">
                    <option value="">-- Select Preset --</option>
                    <optgroup label="Built-in Presets">
                        <option value="2d_rotation">Simple Rotation (2D)</option>
                        <option value="2d_vortex">Vortex (2D)</option>
                        <option value="2d_vanderpol">Van der Pol Oscillator (2D)</option>
                        <option value="2d_fluid_stirring">Fluid Transport with Stirring (2D)</option>
                        <option value="3d_lorenz">Lorenz Attractor (3D)</option>
                        <option value="3d_rossler">RÃ¶ssler Attractor (3D)</option>
                        <option value="4d_hypersphere">4D Hypersphere Rotation</option>
                        <option value="4d_double_pendulum">Double Pendulum (4D Chaotic)</option>
                    </optgroup>
                    <optgroup label="Custom Presets" id="custom-presets-group" style="display: none;">
                    </optgroup>
                </select>
            </div>
        </div>

        <div class="control-group">
            <label>Save Current as Preset:</label>
            <div style="display: flex; gap: 6px;">
                <input type="text" id="preset-name-input" placeholder="Enter preset name..." style="flex: 1; padding: 6px; border: 1px solid #444; background: #222; color: white; border-radius: 4px; font-size: 11px;">
                <button id="save-preset-btn" class="secondary">Save</button>
                <button id="delete-preset-btn" class="secondary" style="display: none;">Delete</button>
            </div>
            <div class="info">Save current settings as a custom preset</div>
        </div>

        <div class="control-group">
            <label>Dimensions: <span class="range-value" id="dim-value">2</span></label>
            <div class="slider-control">
                <button class="slider-btn" data-slider="dimensions" data-action="decrease">-</button>
                <input type="range" id="dimensions">
                <button class="slider-btn" data-slider="dimensions" data-action="increase">+</button>
            </div>
            <div class="info">Number of dimensions in the system</div>
        </div>

        <h2>Vector Field Equations</h2>
        <div class="accordion-section">
            <div id="dimension-inputs" class="dimension-inputs">
                <!-- Dynamically generated -->
            </div>
            <div class="info">Enter math expressions using variables x, y, z, w, u, v</div>
        </div>

        <h2>Integrator</h2>
        <div class="accordion-section">
            <div class="control-group">
                <select id="integrator">
                    <optgroup label="Explicit Methods">
                        <option value="euler">Euler (1st order)</option>
                        <option value="explicit-midpoint">Explicit Midpoint (2nd order)</option>
                        <option value="heun">Heun (Explicit Trapezoidal, 2nd order)</option>
                        <option value="rk4" selected>RK4 (4th order)</option>
                    </optgroup>
                    <optgroup label="Implicit Methods (A-stable)">
                        <option value="implicit-euler">Implicit Euler (1st order)</option>
                        <option value="implicit-midpoint">Implicit Midpoint (2nd order)</option>
                        <option value="trapezoidal">Trapezoidal (2nd order)</option>
                        <option value="implicit-rk4">Implicit RK4 (4th order)</option>
                    </optgroup>
                    <optgroup label="Special Methods">
                        <option value="custom">Custom (Advanced)</option>
                    </optgroup>
                </select>
                <div class="info">Explicit methods: Euler â†” Implicit Euler, Midpoint â†” Implicit Midpoint, Heun â†” Trapezoidal, RK4 â†” Implicit RK4. Implicit methods are A-stable and allow larger timesteps for stiff systems.</div>
            </div>

            <div class="control-group" id="solution-method-group" style="display: none;">
                <label>Solution Method</label>
                <select id="solution-method">
                    <option value="fixed-point">Fixed-Point Iteration</option>
                    <option value="midpoint">Midpoint Solver</option>
                    <option value="newton">Newton's Method</option>
                    <option value="newton-fd">Newton (Finite Diff)</option>
                </select>
                <div class="info">Fixed-point creates interesting chaotic artifacts. Midpoint solver (predictor-corrector) offers a balance between speed and accuracy. Newton's method uses symbolic differentiation (most accurate). Newton (Finite Diff) approximates the Jacobian numerically and may create unique visual artifacts.</div>
            </div>

            <div class="control-group">
                <label>Time Step: <span class="range-value" id="timestep-value">0.01</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="timestep" data-action="decrease-large" title="Decrease by 0.01">--</button>
                    <button class="slider-btn" data-slider="timestep" data-action="decrease" title="Decrease by 0.001">-</button>
                    <input type="range" id="timestep">
                    <button class="slider-btn" data-slider="timestep" data-action="increase" title="Increase by 0.001">+</button>
                    <button class="slider-btn" data-slider="timestep" data-action="increase-large" title="Increase by 0.01">++</button>
                    <button class="slider-btn" data-slider="timestep" data-action="reset" title="Reset to 0.01">â†º</button>
                    <!-- Animation button will be added by AnimatableTimestepControl -->
                </div>
                <div class="info">Fine control: +/- = 0.001, ++/-- = 0.01. Scaled by integrator cost factor. Click ðŸŽ¬ to enable animation.</div>
            </div>

            <div class="control-group" id="implicit-iterations-group" style="display: none;">
                <label>Solver Iterations: <span class="range-value" id="implicit-iterations-value">4</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="implicit-iterations" data-action="decrease">-</button>
                    <input type="range" id="implicit-iterations">
                    <button class="slider-btn" data-slider="implicit-iterations" data-action="increase">+</button>
                </div>
                <div class="info">Number of iterations for implicit solver. Higher = more accurate but slower. Newton converges faster than fixed-point.</div>
            </div>
        </div>

        <h2>Domain Transform</h2>
        <div class="accordion-section">
            <div class="control-group">
                <select id="transform">
                    <option value="identity" selected>No Transform (Identity)</option>
                    <optgroup label="Stretch/Compress Near Zero">
                        <option value="log">Logarithmic (Stretch Near Zero)</option>
                        <option value="exp">Exponential (Compress Near Zero)</option>
                        <option value="power">Power Transform (Configurable)</option>
                    </optgroup>
                    <optgroup label="Bounded Compression">
                        <option value="softsign">Soft-sign (To [-1,1], Simple)</option>
                        <option value="tanh">Hyperbolic Tangent (To [-1,1], Smooth)</option>
                        <option value="sigmoid">Logistic Sigmoid (To [-1,1], S-curve)</option>
                        <option value="rational">Rational (To [-1,1], Bell Jacobian)</option>
                    </optgroup>
                    <optgroup label="Special Effects">
                        <option value="sine">Sine Wave (Periodic Speed Bumps)</option>
                        <option value="radial_power">Radial Power (Distance-based)</option>
                    </optgroup>
                    <optgroup label="Advanced">
                        <option value="custom">Custom (User GLSL)</option>
                    </optgroup>
                </select>
                <div class="info">Transform phase space before integration. Creates spatially-varying effective timestep while preserving convergence.</div>
            </div>

            <div id="transform-controls">
                <!-- Dynamically generated based on transform type -->
            </div>
        </div>

        <h2>2D Projection</h2>
        <div class="accordion-section">
            <div class="control-group">
                <select id="mapper">
                    <option value="select" selected>Select 2 Variables</option>
                    <option value="project">Linear Projection</option>
                    <option value="custom">Custom (Advanced)</option>
                </select>
            </div>

            <div id="mapper-controls">
                <!-- Dynamically generated based on mapper type -->
            </div>
        </div>

        <h2>Rendering</h2>
        <div class="accordion-section">
            <div class="control-group">
                <label>Color Mode:</label>
                <select id="color-mode">
                    <option value="white">Solid White</option>
                    <option value="velocity_magnitude">Velocity Magnitude</option>
                    <option value="velocity_angle">Velocity Angle</option>
                    <option value="velocity_combined">Velocity Angle + Magnitude</option>
                    <option value="expression">Expression</option>
                    <option value="custom">Custom (Advanced)</option>
                </select>
            </div>

            <div class="control-group" id="gradient-button-container" style="display: none;">
                <button id="open-gradient-editor" class="secondary" style="width: 100%;">Edit Gradient</button>
                <div class="info">Customize color gradient for this mode</div>
            </div>

            <div class="control-group" id="velocity-scaling-container" style="display: none;">
                <label>Velocity Scaling:</label>
                <select id="velocity-scale-mode">
                    <option value="percentile95">95th Percentile (Recommended)</option>
                    <option value="percentile90">90th Percentile</option>
                    <option value="average">Average</option>
                    <option value="max">Maximum</option>
                </select>
                <div class="info">What velocity to map to full color saturation. Percentiles ignore outliers for better color distribution.</div>
            </div>

            <div class="control-group" id="velocity-log-container" style="display: none;">
                <label>
                    <input type="checkbox" id="velocity-log-scale">
                    Logarithmic Velocity Scale
                </label>
                <div class="info">Maps velocity using log scale for better visualization when velocity range is very large</div>
            </div>

            <div id="expression-controls" style="display: none;">
                <div class="control-group">
                    <label>Color Expression:</label>
                    <input type="text" id="color-expression" placeholder="e.g., sin(x*y), length(pos), dx*dy" value="x * y">
                    <div class="info">Expression that evaluates to [0,1]. Use x,y,z,w for position, dx,dy,dz,dw for velocity</div>
                </div>
            </div>

            <div class="control-group">
                <label>Particle Count: <span class="range-value" id="particles-value">1000</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="particles" data-action="decrease">-</button>
                    <input type="range" id="particles">
                    <button class="slider-btn" data-slider="particles" data-action="increase">+</button>
                </div>
            </div>

            <div class="control-group">
                <label>Fade Speed: <span class="range-value" id="fade-value">0.999</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="fade" data-action="decrease">-</button>
                    <input type="range" id="fade">
                    <button class="slider-btn" data-slider="fade" data-action="increase">+</button>
                </div>
                <div class="info">Logarithmic scale: slower fade preserves trails longer</div>
            </div>

            <div class="control-group">
                <label>Drop Probability: <span class="range-value" id="drop-value">0.000</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="drop" data-action="decrease">-</button>
                    <input type="range" id="drop">
                    <button class="slider-btn" data-slider="drop" data-action="increase">+</button>
                </div>
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="drop-low-velocity">
                    Drop low velocity particles (&lt;2% max speed)
                </label>
            </div>


            <div class="control-group">
                <button id="open-rendering-settings" class="secondary" style="width: 100%;">Rendering Effects</button>
                <div class="info">HDR, tone mapping, and particle intensity settings</div>
            </div>

            <div class="control-group">
                <button id="open-custom-functions" class="secondary" style="width: 100%;">Custom Functions</button>
                <div class="info">Define custom mathematical functions in GLSL</div>
            </div>
        </div>

        <h2>Advanced</h2>
        <div class="accordion-section">
            <div class="control-group">
                <label>Storage Strategy:</label>
                <select id="storage-strategy">
                    <option value="rgba">RGBA Encoded (broken!)</option>
                    <option value="float" selected>Float Textures (Modern)</option>
                </select>
                <div class="info">RGBA encoding has coordinate mapping bugs. Use Float textures. Requires page reload.</div>
            </div>
        </div>

        <div id="error-message"></div>
    </div>

    <div id="zoom-pan-controls">
        <h1>View</h1>

        <!-- Pan controls in a 3x3 grid -->
        <div class="zoom-pan-grid">
            <button class="zoom-pan-btn" id="pan-up-left" title="Pan Up-Left">â†–</button>
            <button class="zoom-pan-btn" id="pan-up" title="Pan Up">â–²</button>
            <button class="zoom-pan-btn" id="pan-up-right" title="Pan Up-Right">â†—</button>
            <button class="zoom-pan-btn" id="pan-left" title="Pan Left">â—€</button>
            <button class="zoom-pan-btn" id="pan-reset" title="Center View at Origin">âŠ™</button>
            <button class="zoom-pan-btn" id="pan-right" title="Pan Right">â–¶</button>
            <button class="zoom-pan-btn" id="pan-down-left" title="Pan Down-Left">â†™</button>
            <button class="zoom-pan-btn" id="pan-down" title="Pan Down">â–¼</button>
            <button class="zoom-pan-btn" id="pan-down-right" title="Pan Down-Right">â†˜</button>
        </div>

        <!-- Zoom controls -->
        <div class="zoom-btn-group">
            <button class="zoom-pan-btn zoom-btn" id="zoom-out" title="Zoom Out">âˆ’</button>
            <button class="zoom-pan-btn zoom-btn" id="zoom-in" title="Zoom In">+</button>
        </div>
    </div>

    <div id="display-options">
        <h1>Display</h1>

        <div class="control-group">
            <label>
                <input type="checkbox" id="show-grid" checked>
                Show coordinate grid
            </label>
        </div>

        <div class="control-group">
            <div style="display: flex; gap: 6px; width: 100%; margin-bottom: 6px;">
                <button id="reset" class="secondary" style="flex: 1;">Reset View</button>
                <button id="reset-particles" class="secondary" style="flex: 1;">Clear Screen (C)</button>
            </div>
            <div style="display: flex; gap: 6px; width: 100%; margin-bottom: 6px;">
                <button id="default-settings" class="secondary" style="flex: 1;">Default Settings</button>
                <button id="share-url" class="secondary" style="flex: 1;">Share URL</button>
            </div>
            <div style="display: flex; gap: 6px; width: 100%;">
                <button id="save-image" class="secondary" style="flex: 1;">Save Image</button>
            </div>
        </div>

        <!-- Animation Section -->
        <h1 style="cursor: pointer; user-select: none;" id="animation-section-toggle">
            Animation <span id="animation-section-arrow">â–¼</span>
        </h1>
        <div id="animation-section-content" style="display: none;">
            <h4 style="margin: 8px 0; padding: 0; font-size: 12px; color: #4CAF50;">Interactive Testing</h4>

            <!-- Animation alpha control will be injected here -->
            <div id="animation-alpha-container"></div>

            <!-- Animation speed control -->
            <div id="animation-speed-container"></div>

            <div class="control-group" style="margin-top: 12px;">
                <label style="display: flex; align-items: center; cursor: pointer;" title="Reinitialize particle positions when alpha updates">
                    <input type="checkbox" id="animation-clear-particles" style="margin-right: 8px;">
                    <span>Reset particles on alpha change</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;" title="Clear screen and freeze rendering between alpha updates for clean transitions">
                    <input type="checkbox" id="animation-clear-screen" style="margin-right: 8px;">
                    <span>Freeze screen between alpha changes</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;" title="Maintain consistent frame time by adding delays to faster alpha steps">
                    <input type="checkbox" id="animation-smooth-timing" style="margin-right: 8px;">
                    <span>Alpha step time smoothing</span>
                </label>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;" title="When enabled, prevents shader recompilation while animation is playing (prevents hiccups from parameter changes)">
                    <input type="checkbox" id="animation-lock-shaders" style="margin-right: 8px;">
                    <span>Lock shaders during playback</span>
                </label>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="export-animation-json" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ðŸ’¾ Export Settings as Animation JSON
                </button>
                <div class="info">Export current settings as animation base template</div>
            </div>

            <hr style="border: none; border-top: 1px solid #333; margin: 16px 0;">


            <h4 style="margin: 8px 0; padding: 0; font-size: 12px; color: #4CAF50;">Create Animation</h4>

            <div class="control-group">
                <label>Frames:</label>
                <input type="number" id="animation-frames" value="100" min="1" max="10000" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
                <div class="info">Total number of frames to capture</div>
            </div>

            <div class="control-group">
                <label>Loops:</label>
                <input type="number" id="animation-loops" value="1" min="1" max="100" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
                <div class="info" id="animation-loops-info">Number of complete alpha cycles (0.0 â†’ 1.0 â†’ 0.0)</div>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="animation-half-loops" style="margin-right: 8px;">
                    <span>Count as half-loops</span>
                </label>
                <div class="info">When enabled, 1 loop = 0.0 â†’ 1.0 (one-way). When disabled, 1 loop = 0.0 â†’ 1.0 â†’ 0.0 (ping-pong)</div>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="animation-create-btn" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    â–¶ Create Animation
                </button>
            </div>

            <div id="animation-progress" style="display: none; margin-top: 12px;">
                <div style="font-size: 10px; margin-bottom: 4px;">
                    <span id="progress-text">Frame 0 / 0</span>
                    <span id="progress-alpha" style="float: right; color: #4CAF50;">Î±: 0.00</span>
                </div>
                <div style="background: #2a2a2a; border-radius: 4px; overflow: hidden; height: 16px; border: 1px solid #444;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; height: 100%; transition: width 0.3s;"></div>
                </div>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="animation-download-btn" style="width: 100%; padding: 6px; background: #42A5F5; color: white; border: none; border-radius: 4px; cursor: pointer;" disabled>
                    ðŸ’¾ Download Animation (ZIP)
                </button>
                <div class="info" style="font-size: 9px;">Create MP4: <code style="background: #000; padding: 2px 4px; border-radius: 2px;">./scripts/create-video.sh animation.zip out.mp4 30</code></div>
            </div>
        </div>
    </div>

    <canvas id="grid-canvas"></canvas>

    <div id="cursor-position"></div>

    <div id="histogram-panel">
        <div id="histogram-header">
            <h4>HDR Brightness Histogram</h4>
            <span id="histogram-expand">â–¼</span>
        </div>
        <div id="histogram-body">
            <canvas id="histogram-canvas"></canvas>
            <div id="histogram-info">
                Avg: <span id="hist-avg">--</span> | Max: <span id="hist-max">--</span><br>
                Max Vel: <span id="hist-vel">--</span>
            </div>
        </div>
    </div>

    <div id="step-time-counter" style="display: none;">Step: --ms</div>
    <div id="fps-counter">FPS: --</div>

    <div id="debug-console" class="collapsed">
        <div id="debug-header">
            <input type="checkbox" id="debug-toggle" checked>
            <h3>Debug Console</h3>
            <span id="debug-expand">â–¶</span>
        </div>
        <div id="debug-body">
            <div id="debug-controls">
                <select id="debug-verbosity">
                    <option value="info">Info</option>
                    <option value="debug">Debug</option>
                    <option value="verbose">Verbose</option>
                    <option value="warn">Warnings Only</option>
                    <option value="error">Errors Only</option>
                    <option value="silent">Silent (Buffer)</option>
                </select>
                <button id="debug-log-update-shader" class="secondary" style="padding: 4px 8px; margin: 0;">Log Update</button>
                <button id="debug-log-draw-shader" class="secondary" style="padding: 4px 8px; margin: 0;">Log Draw</button>
                <button id="debug-log-screen-shader" class="secondary" style="padding: 4px 8px; margin: 0;">Log Screen</button>
                <button id="debug-log-stats-shaders" class="secondary" style="padding: 4px 8px; margin: 0;">Log Stats</button>
                <button id="debug-buffer-stats" class="secondary" style="padding: 4px 8px; margin: 0;">Buffer Stats</button>
                <button id="debug-copy" class="secondary" style="padding: 4px 8px; margin: 0;">Copy Log</button>
                <button id="debug-clear" class="secondary" style="padding: 4px 8px; margin: 0;">Clear</button>
            </div>
            <div id="debug-buffer-status" style="display: none; padding: 4px 8px; background: #2a2a2a; border-radius: 4px; margin-bottom: 8px; font-size: 11px; color: #888;">
                <span style="color: #FFA726; font-weight: bold;">SILENT MODE:</span>
                Buffering <span id="buffer-size" style="color: #4CAF50;">0</span> logs
                (<span id="buffer-percent">0</span>% of max)
                <button id="debug-flush-buffer" class="secondary" style="padding: 2px 6px; margin-left: 8px; font-size: 10px;">Flush Buffer</button>
                <button id="debug-clear-buffer" class="secondary" style="padding: 2px 6px; margin-left: 4px; font-size: 10px;">Clear Buffer</button>
            </div>
            <div style="padding: 4px 8px; margin-bottom: 8px;">
                <label style="display: flex; align-items: center; cursor: pointer; font-size: 11px;" title="Enable particle sampling and detailed logging (expensive GPU readback). Buffer stats for tone mapping are always enabled but optimized.">
                    <input type="checkbox" id="debug-enable-stats" style="margin-right: 6px;">
                    <span>Enable Particle Sampling</span>
                </label>
            </div>
            <div id="debug-output"></div>
        </div>
    </div>

    <!-- Floating gradient panel -->
    <div id="gradient-panel" class="floating-panel" style="display: none;">
        <div class="floating-panel-header">
            <h3>Gradient Editor</h3>
        </div>
        <div class="floating-panel-content">
            <div id="gradient-preset-toggle" style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #444;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="use-custom-gradient" style="margin-right: 8px;">
                    <span>Apply to preset color modes</span>
                </label>
                <div class="info" style="margin-top: 5px;">When disabled, preset modes use built-in colors</div>
            </div>
            <div id="main-gradient-editor"></div>
        </div>
    </div>

    <!-- Floating rendering settings panel -->
    <div id="rendering-panel" class="floating-panel" style="display: none;">
        <div class="floating-panel-header">
            <h3>Rendering Effects</h3>
        </div>
        <div class="floating-panel-content">
            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">HDR Rendering</h4>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="use-hdr" checked>
                    Enable HDR (float framebuffers)
                </label>
                <div class="info">High Dynamic Range rendering with tone mapping</div>
            </div>

            <div class="control-group">
                <label>
                    <input type="checkbox" id="use-depth-test">
                    Enable Depth Testing (Plasma Mode)
                </label>
                <div class="info">Use Z-buffer to occlude particles by depth. Creates layered density effect in 3D systems.</div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Supersampling (SSAA)</h4>
            <div class="control-group">
                <label>Supersample Factor: <span class="range-value" id="supersample-factor-value">1.0x</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="supersample-factor" data-action="decrease">-</button>
                    <input type="range" id="supersample-factor">
                    <button class="slider-btn" data-slider="supersample-factor" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="supersample-factor" data-action="reset" title="Reset to default (1.0x)">â†º</button>
                </div>
                <div class="info">Render at higher resolution and downsample (0.5x - 3.0x). Higher = better quality but slower. 2.0x = 4x samples.</div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">SMAA Antialiasing</h4>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="smaa-enabled" checked>
                    Enable SMAA (morphological AA)
                </label>
                <div class="info">Pattern-based antialiasing. Better edge preservation than FXAA - uses edge detection and pattern recognition.</div>
            </div>

            <div class="control-group">
                <label>SMAA Intensity: <span class="range-value" id="smaa-intensity-value">0.75</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="smaa-intensity" data-action="decrease">-</button>
                    <input type="range" id="smaa-intensity">
                    <button class="slider-btn" data-slider="smaa-intensity" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="smaa-intensity" data-action="reset" title="Reset to default (0.75)">â†º</button>
                </div>
                <div class="info">Blend strength (0.0 - 1.0). Controls how much smoothing is applied to detected edges.</div>
            </div>

            <div class="control-group">
                <label>SMAA Threshold: <span class="range-value" id="smaa-threshold-value">0.10</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="smaa-threshold" data-action="decrease">-</button>
                    <input type="range" id="smaa-threshold">
                    <button class="slider-btn" data-slider="smaa-threshold" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="smaa-threshold" data-action="reset" title="Reset to default (0.10)">â†º</button>
                </div>
                <div class="info">Edge detection sensitivity (0.0 - 0.5). Lower = more edges detected, higher = only strong edges.</div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Bilateral Filter (Noise Reduction)</h4>
            <div class="control-group">
                <label>
                    <input type="checkbox" id="bilateral-enabled">
                    Enable Bilateral Filter
                </label>
                <div class="info">Edge-preserving blur. Smooths flat/sparse areas while preserving sharp edges and particle trails.</div>
            </div>

            <div class="control-group">
                <label>Spatial Sigma: <span class="range-value" id="bilateral-spatial-value">4.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="bilateral-spatial" data-action="decrease">-</button>
                    <input type="range" id="bilateral-spatial">
                    <button class="slider-btn" data-slider="bilateral-spatial" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="bilateral-spatial" data-action="reset" title="Reset to default (4.0)">â†º</button>
                </div>
                <div class="info">Blur radius (0.5 - 5.0). Higher = stronger smoothing effect.</div>
            </div>

            <div class="control-group">
                <label>Intensity Sigma: <span class="range-value" id="bilateral-intensity-value">0.20</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="bilateral-intensity" data-action="decrease">-</button>
                    <input type="range" id="bilateral-intensity">
                    <button class="slider-btn" data-slider="bilateral-intensity" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="bilateral-intensity" data-action="reset" title="Reset to default (0.20)">â†º</button>
                </div>
                <div class="info">Edge preservation threshold (0.01 - 0.5). Lower = preserve more edges, higher = blur across edges.</div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Tone Mapping</h4>
            <div class="control-group">
                <label>Operator:</label>
                <select id="tonemap-operator">
                    <option value="aces" selected>ACES (Film-like)</option>
                    <option value="reinhard">Reinhard (Simple)</option>
                    <option value="reinhard_extended">Reinhard Extended</option>
                    <option value="luminance_reinhard">Luminance Reinhard (Hue Preserving)</option>
                    <option value="luminance_extended">Luminance Extended (Best for Attractors)</option>
                    <option value="filmic">Filmic</option>
                    <option value="uncharted2">Uncharted 2 (Game-style)</option>
                    <option value="hable">Hable Filmic</option>
                    <option value="linear">Linear (No Tone Mapping)</option>
                </select>
                <div class="info">Compresses HDR â†’ LDR. Luminance modes preserve color hue/saturation perfectly.</div>
            </div>

            <div class="control-group">
                <label>Exposure: <span class="range-value" id="exposure-value">1.00</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="exposure" data-action="decrease">-</button>
                    <input type="range" id="exposure">
                    <button class="slider-btn" data-slider="exposure" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="exposure" data-action="reset" title="Reset to default (1.0)">â†º</button>
                </div>
                <div class="info">Logarithmic scale (0.01 - 10.0). Use low values (0.05-0.2) for attractor visualization with high gamma.</div>
            </div>

            <div class="control-group">
                <label>Gamma: <span class="range-value" id="gamma-value">2.2</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="gamma" data-action="decrease">-</button>
                    <input type="range" id="gamma">
                    <button class="slider-btn" data-slider="gamma" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="gamma" data-action="reset" title="Reset to default (2.2)">â†º</button>
                </div>
                <div class="info">Logarithmic scale (0.2 - 10.0). Use high values (3.0-10.0) for aggressive shadow lifting in attractors.</div>
            </div>

            <div class="control-group">
                <label>Luminance Gamma: <span class="range-value" id="luminance-gamma-value">1.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="luminance-gamma" data-action="decrease">-</button>
                    <input type="range" id="luminance-gamma">
                    <button class="slider-btn" data-slider="luminance-gamma" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="luminance-gamma" data-action="reset" title="Reset to default (1.0)">â†º</button>
                </div>
                <div class="info">Logarithmic scale (0.2 - 10.0). Adjusts brightness only, preserving hue. Applied after regular gamma.</div>
            </div>

            <div class="control-group" id="white-point-control">
                <label>White Point: <span class="range-value" id="white-point-value">2.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="white-point" data-action="decrease">-</button>
                    <input type="range" id="white-point">
                    <button class="slider-btn" data-slider="white-point" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="white-point" data-action="reset" title="Reset to default (2.0)">â†º</button>
                </div>
                <div class="info">Brightest value that maps to white. Also used as bloom threshold.</div>
            </div>

            <!-- Bloom Effect (Hidden - WIP) -->
            <div style="display: none;">
                <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Bloom Effect</h4>
                <div class="control-group">
                    <label>
                        <input type="checkbox" id="bloom-enabled">
                        Enable Bloom (bright regions glow)
                    </label>
                    <div class="info">Extracts pixels above white point, blurs them, and adds glow.</div>
                </div>

                <div class="control-group">
                    <label>Bloom Intensity: <span class="range-value" id="bloom-intensity-value">0.30</span></label>
                    <div class="slider-control">
                        <button class="slider-btn" data-slider="bloom-intensity" data-action="decrease">-</button>
                        <input type="range" id="bloom-intensity">
                        <button class="slider-btn" data-slider="bloom-intensity" data-action="increase">+</button>
                        <button class="slider-btn" data-slider="bloom-intensity" data-action="reset" title="Reset to default (0.3)">â†º</button>
                    </div>
                    <div class="info">Bloom layer strength (0.0 - 2.0). Higher = stronger glow.</div>
                </div>

                <div class="control-group">
                    <label>Bloom Radius: <span class="range-value" id="bloom-radius-value">1.0</span></label>
                    <div class="slider-control">
                        <button class="slider-btn" data-slider="bloom-radius" data-action="decrease">-</button>
                        <input type="range" id="bloom-radius">
                        <button class="slider-btn" data-slider="bloom-radius" data-action="increase">+</button>
                        <button class="slider-btn" data-slider="bloom-radius" data-action="reset" title="Reset to default (1.0)">â†º</button>
                    </div>
                    <div class="info">Blur radius (0.5 - 3.0). Higher = wider glow spread.</div>
                </div>

                <div class="control-group">
                    <label>Bloom Alpha: <span class="range-value" id="bloom-alpha-value">1.00</span></label>
                    <div class="slider-control">
                        <button class="slider-btn" data-slider="bloom-alpha" data-action="decrease">-</button>
                        <input type="range" id="bloom-alpha">
                        <button class="slider-btn" data-slider="bloom-alpha" data-action="increase">+</button>
                        <button class="slider-btn" data-slider="bloom-alpha" data-action="reset" title="Reset to default (1.0)">â†º</button>
                    </div>
                    <div class="info">Bloom transparency (0.0 - 1.0). Lower = more transparent, higher = more opaque.</div>
                </div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Intensity</h4>
            <div class="control-group">
                <label>Intensity: <span class="range-value" id="particle-intensity-value">1.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="particle-intensity" data-action="decrease">-</button>
                    <input type="range" id="particle-intensity">
                    <button class="slider-btn" data-slider="particle-intensity" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="particle-intensity" data-action="reset" title="Reset to default (1.0)">â†º</button>
                </div>
                <div class="info">Logarithmic scale (0.001 - 100.0). Brightness multiplier for particles. Use very low values (0.01-0.05) for attractor visualization.</div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Size</h4>
            <div class="control-group">
                <label>Size: <span class="range-value" id="particle-size-value">1.0</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="particle-size" data-action="decrease">-</button>
                    <input type="range" id="particle-size">
                    <button class="slider-btn" data-slider="particle-size" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="particle-size" data-action="reset" title="Reset to default (1.0)">â†º</button>
                </div>
                <div class="info">Logarithmic scale (0.1 - 10.0). Size of rendered particles in pixels.</div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Particle Render Mode</h4>
            <div class="control-group">
                <label>Mode:</label>
                <select id="particle-render-mode">
                    <option value="points">Points</option>
                    <option value="lines">Lines (Motion Trails)</option>
                </select>
                <div class="info">Render particles as points or as lines connecting consecutive positions for motion trails.</div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Color Saturation</h4>
            <div class="control-group">
                <label>Saturation: <span class="range-value" id="color-saturation-value">1.00</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="color-saturation" data-action="decrease">-</button>
                    <input type="range" id="color-saturation">
                    <button class="slider-btn" data-slider="color-saturation" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="color-saturation" data-action="reset" title="Reset to default (1.0)">â†º</button>
                </div>
                <div class="info">Color saturation (0.0 - 1.0). Reduce for pastel colors ideal for attractor density visualization.</div>
            </div>

            <h4 style="margin: 16px 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Brightness Desaturation</h4>
            <div class="control-group">
                <label>Bright Desat: <span class="range-value" id="brightness-desat-value">0.00</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="brightness-desat" data-action="decrease">-</button>
                    <input type="range" id="brightness-desat">
                    <button class="slider-btn" data-slider="brightness-desat" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="brightness-desat" data-action="reset" title="Reset to default (0.0)">â†º</button>
                </div>
                <div class="info">Desaturates bright regions (0.0 - 1.0). Prevents fully saturated colors in dense attractor areas.</div>
            </div>

            <div class="control-group">
                <label>Saturation Buildup: <span class="range-value" id="saturation-buildup-value">0.00</span></label>
                <div class="slider-control">
                    <button class="slider-btn" data-slider="saturation-buildup" data-action="decrease">-</button>
                    <input type="range" id="saturation-buildup">
                    <button class="slider-btn" data-slider="saturation-buildup" data-action="increase">+</button>
                    <button class="slider-btn" data-slider="saturation-buildup" data-action="reset" title="Reset to default (0.0)">â†º</button>
                </div>
                <div class="info">Desaturates dim regions, saturates bright regions (0.0 - 1.0). Sparse trails look washed out, dense accumulations pop with full color. Higher values = more aggressive effect.</div>
            </div>
        </div>
    </div>

    <!-- Floating custom functions panel -->
    <div id="custom-functions-panel" class="floating-panel" style="display: none;">
        <div class="floating-panel-header">
            <h3>Custom Functions</h3>
        </div>
        <div class="floating-panel-content">
            <div class="info" style="margin-bottom: 16px;">
                Define custom functions using mathematical syntax. Functions can be used in vector field expressions, color expressions, and mapper functions.
            </div>

            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Syntax</h4>
            <div class="info" style="margin-bottom: 16px; font-family: monospace; background: #000; padding: 8px; border-radius: 4px; font-size: 11px;">
                functionName(arg1, arg2, ...) = expression<br>
                <br>
                <span style="color: #888;">Examples:</span><br>
                <span style="color: #4CAF50;">smoothstep(x, a, b) = ((x-a)/(b-a))^3 * (3 - 2*((x-a)/(b-a)))</span><br>
                <span style="color: #4CAF50;">lerp(a, b, t) = a * (1-t) + b * t</span><br>
                <span style="color: #4CAF50;">sqr(x) = x * x</span><br>
                <span style="color: #4CAF50;">cube(x) = x * x * x</span>
            </div>

            <h4 style="margin: 0 0 8px 0; padding: 0; font-size: 14px; color: #4CAF50;">Function Definitions</h4>
            <div class="control-group">
                <textarea id="custom-functions-input"
                    rows="12"
                    style="width: 100%; font-family: 'Courier New', monospace; font-size: 12px; background: #1a1a1a; color: #4CAF50; border: 1px solid #444; border-radius: 4px; padding: 10px; resize: vertical;"
                    placeholder="Enter custom function definitions (one per line)...&#10;&#10;Example:&#10;smoothstep(x, a, b) = ((x-a)/(b-a))^3 * (3 - 2*((x-a)/(b-a)))"></textarea>
                <div class="info">One function per line. Use standard math operators (+, -, *, /, ^) and built-in functions (sin, cos, exp, log, sqrt, abs, etc.)</div>
            </div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="apply-custom-functions" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    Apply Functions
                </button>
            </div>

            <div id="custom-functions-error" style="display: none; margin-top: 12px; padding: 8px; background: rgba(244, 67, 54, 0.1); border: 1px solid #f44336; border-radius: 4px; color: #f44336; font-size: 11px;"></div>

            <div id="custom-functions-success" style="display: none; margin-top: 12px; padding: 8px; background: rgba(76, 175, 80, 0.1); border: 1px solid #4CAF50; border-radius: 4px; color: #4CAF50; font-size: 11px;"></div>
        </div>
    </div>

    <!-- Floating animation panel -->
    <div id="animation-panel" class="floating-panel" style="display: none; left: 20px; right: auto; z-index: 10000;">
        <div class="floating-panel-header">
            <h3>Animation</h3>
            <button id="animation-panel-lock" style="background: none; border: 1px solid #666; color: #666; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 16px; margin-left: auto;" title="Lock panel open">ðŸ”“</button>
        </div>
        <div class="floating-panel-content">
            <!-- Animation Testing Section -->
            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Interactive Testing</h4>

            <!-- Animation alpha control will be injected here -->
            <div id="animation-alpha-container"></div>

            <!-- Animation speed control -->
            <div id="animation-speed-container"></div>

            <div class="control-group" style="margin-top: 12px;">
                <button id="export-animation-json" style="width: 100%; padding: 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ðŸ’¾ Export Settings as Animation JSON
                </button>
                <div class="info">Export current settings as animation base template</div>
            </div>

            <hr style="border: none; border-top: 1px solid #333; margin: 20px 0;">

            <h4 style="margin: 0 0 12px 0; padding: 0; font-size: 14px; color: #4CAF50;">Create Animation</h4>

            <div class="control-group">
                <label>Frames:</label>
                <input type="number" id="animation-frames" value="100" min="1" max="10000" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
                <div class="info">Total number of frames to capture</div>
            </div>

            <div class="control-group">
                <label>Loops:</label>
                <input type="number" id="animation-loops" value="1" min="1" max="100" style="width: 100%; padding: 6px; background: #333; border: 1px solid #555; color: #fff; border-radius: 3px;">
                <div class="info" id="animation-loops-info">Number of complete alpha cycles (0.0 â†’ 1.0 â†’ 0.0)</div>
            </div>

            <div class="control-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="animation-half-loops" style="margin-right: 8px;">
                    <span>Count as half-loops</span>
                </label>
                <div class="info">When enabled, 1 loop = 0.0 â†’ 1.0 (one-way). When disabled, 1 loop = 0.0 â†’ 1.0 â†’ 0.0 (ping-pong)</div>
            </div>

            <div class="control-group" style="margin-top: 16px;">
                <button id="animation-create-btn" style="width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                    â–¶ Create Animation
                </button>
            </div>

            <div id="animation-progress" style="display: none; margin-top: 12px;">
                <div style="font-size: 11px; margin-bottom: 6px;">
                    <span id="progress-text">Frame 0 / 0</span>
                    <span id="progress-alpha" style="float: right; color: #4CAF50;">Î±: 0.00</span>
                </div>
                <div style="background: #2a2a2a; border-radius: 4px; overflow: hidden; height: 20px; border: 1px solid #444;">
                    <div id="progress-bar" style="background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; height: 100%; transition: width 0.3s;"></div>
                </div>
            </div>

            <div class="control-group" style="margin-top: 16px;">
                <button id="animation-download-btn" style="width: 100%; padding: 8px; background: #42A5F5; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;" disabled>
                    ðŸ’¾ Download Animation (ZIP)
                </button>
                <div class="info">Create MP4: <code style="background: #000; padding: 2px 4px; border-radius: 2px; font-size: 9px;">./scripts/create-video.sh animation.zip out.mp4 30</code></div>
            </div>
        </div>
    </div>

    <!-- Nerdamer for symbolic differentiation (Jacobian computation) -->
    <script src="https://cdn.jsdelivr.net/npm/nerdamer@latest/all.min.js"></script>
    <!-- JSZip for bundling animation frames -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Register Service Worker and wait for it to be ready before loading modules -->
    <script>
        (async function() {
            // Use timestamp as version
            const version = Date.now();

            // Check if we're on HTTPS or localhost (service workers require secure context)
            const isSecureContext = location.protocol === 'https:' ||
                                   location.hostname === 'localhost' ||
                                   location.hostname === '127.0.0.1';

            // Register and activate service worker first (if available and in secure context)
            if (isSecureContext && 'serviceWorker' in navigator) {
                try {
                    // Unregister all existing service workers first (clean slate)
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (let registration of registrations) {
                        await registration.unregister();
                        console.log('Unregistered old service worker');
                    }

                    // Register fresh service worker
                    const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                    console.log('Service Worker registered for cache-busting', registration);

                    // Wait for service worker to be active
                    await new Promise((resolve) => {
                        if (registration.active) {
                            resolve();
                        } else if (registration.installing) {
                            registration.installing.addEventListener('statechange', function() {
                                if (this.state === 'activated') {
                                    resolve();
                                }
                            });
                        } else if (registration.waiting) {
                            registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                            resolve();
                        }
                    });

                    // Wait for controller
                    if (!navigator.serviceWorker.controller) {
                        console.log('Waiting for service worker to take control...');
                        await new Promise((resolve) => {
                            navigator.serviceWorker.addEventListener('controllerchange', resolve, { once: true });
                        });
                    }

                    console.log('Service Worker is active and controlling page');
                    console.log('Controller:', navigator.serviceWorker.controller);
                } catch (error) {
                    console.warn('Service Worker registration failed:', error);
                }
            } else if (!isSecureContext) {
                console.log('Service Worker disabled: not running on HTTPS or localhost (this is OK for static hosting)');
            } else {
                console.warn('Service Workers not supported in this browser');
            }

            // Load main.js with version
            const script = document.createElement('script');
            script.type = 'module';
            script.src = `src/main.js?v=${version}`;
            document.body.appendChild(script);

            console.log(`Loading main.js entry point with version: ${version}`);
        })();
    </script>
</body>
</html>
